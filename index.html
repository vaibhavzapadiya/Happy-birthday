import { CommonModule } from '@angular/common';
import { Component } from '@angular/core';
import { FormBuilder, FormGroup, ReactiveFormsModule, Validators } from '@angular/forms';
import { User, UserService } from '../Services/user.service';
import { ActivatedRoute, Router } from '@angular/router';

@Component({
  selector: 'app-user-form',
  standalone: true,
  imports: [ReactiveFormsModule, CommonModule],
  templateUrl: './user-form.component.html',
  styleUrl: './user-form.component.css'
})
export class UserFormComponent {
  userlist: User[] = [];
  userForm: FormGroup;
  editemode!: boolean;
  errmsg: string = '';
  editindex: number | null = null;
  constructor(private fb: FormBuilder, private userservice: UserService, private router: Router, private route: ActivatedRoute) {
    this.userForm = this.fb.group({
      name: ['', [Validators.required]],
      email: ['', [Validators.required, Validators.email]],
      gender: ['', [Validators.required]],
      status: ['inactive', [Validators.required]]
    })
    this.route.params.subscribe(params => {
      let id = parseInt(params['id']);
      if (id) {
        this.editemode = true;
        this.editindex = id;
        this.userservice.getuserbyid(id).subscribe(data => {
          this.userForm.patchValue(data);
        })
      }
      else {
        this.editemode = false;
      }
    })
  }


  submit() {

    if (this.userForm.valid) {
      if (this.editemode && this.editindex !== null) {

        if (this.userForm.value.status == 'active') {
          this.userservice.getusers().subscribe(obs => {
            this.userlist = obs.filter(x => x.status == 'active');
            console.log(this.userlist);
            
            if (this.userlist.length > 10) {
              this.errmsg = 'You can not add more than 10 active users';
            }
          })
        }
        else {
          this.userservice.edituser(this.editindex, this.userForm.value).subscribe(x => {
            this.userservice.getusers().subscribe(() => {
              this.router.navigate(['user-list']);
            })

          });
        }


      }
      else {
        this.userservice.adduser(this.userForm.value).subscribe(() => {
          this.userservice.getusers().subscribe(() => {
            this.router.navigate(['user-list']);
          })
        });

      }
    }
    else {
      this.errmsg = 'Please fill all the fields';
    }
  }

  cancel() {
    this.editemode = false;
    this.editindex = null;
    this.router.navigate(['user-list']);
  }

}
